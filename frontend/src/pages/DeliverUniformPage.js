import React, { useState, useRef, useEffect } from 'react';
import { Container, Form, Button, Row, Col, Alert, Card, Spinner } from 'react-bootstrap';
import api from '../api';
import BarcodeScanner from '../components/BarcodeScanner'; // ุชุฃูุฏ ูู ุฃู ูุฐุง ุงููุณุงุฑ ุตุญูุญ

function DeliverUniformPage() {
  const [barcode, setBarcode] = useState('');
  const [item, setItem] = useState(null);
  const [studentData, setStudentData] = useState({
    studentName: '',
    stage: 'ุงุจุชุฏุงุฆู',
    grade: 'ุฃูู',
    section: 'ุฃ',
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [showScanner, setShowScanner] = useState(false); // ุญุงูุฉ ููุชุญูู ูู ุธููุฑ ุงููุงุณุญ
  const barcodeInputRef = useRef(null);

  // ููุชุฑููุฒ ุนูู ุญูู ุงูุฅุฏุฎุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
  useEffect(() => {
    if (!showScanner && barcodeInputRef.current) {
        barcodeInputRef.current.focus();
    }
  }, [showScanner]);

  const handleBarcodeSearch = async (e) => {
    e.preventDefault();
    if (!barcode) return;
    setLoading(true);
    setError('');
    setSuccess('');
    setItem(null);
    try {
      const response = await api.get(`/api/delivery/item/${barcode}`);
      setItem(response.data);
    } catch (err) {
      setError(err.response?.data?.msg || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ ุนู ุงูุจุงุฑููุฏ');
    } finally {
      setLoading(false);
    }
  };

  const handleRecordDelivery = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    setSuccess('');
    try {
      const payload = { ...studentData, barcode };
      const response = await api.post('/api/delivery/record', payload);
      setSuccess(response.data.msg);
      // ุฅุนุงุฏุฉ ุชุนููู ุงูุญุงูุฉ ุจุนุฏ ุงููุฌุงุญ
      setBarcode('');
      setItem(null);
      setStudentData({ studentName: '', stage: 'ุงุจุชุฏุงุฆู', grade: 'ุฃูู', section: 'ุฃ' });
    } catch (err) {
      setError(err.response?.data?.msg || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชูุซูู ุงูุชุณููู');
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e) => {
    setStudentData({ ...studentData, [e.target.name]: e.target.value });
  };
  
  // ุฏุงูุฉ ููุชู ุงุณุชุฏุนุงุคูุง ุนูุฏ ูุฌุงุญ ุงููุณุญ
  const handleScanSuccess = (decodedText) => {
    setBarcode(decodedText);
    setShowScanner(false);
    // ููููู ุฅุถุงูุฉ ุจุญุซ ุชููุงุฆู ููุง ุฅุฐุง ุฃุฑุฏุช
    // document.getElementById('search-button').click(); 
  };

  // ุฏุงูุฉ ููุชู ุงุณุชุฏุนุงุคูุง ุนูุฏ ูุดู ุงููุณุญ
  const handleScanError = (errorMessage) => {
    console.error(errorMessage);
    setShowScanner(false);
    setError('ูุดู ูุณุญ ุงูุจุงุฑููุฏุ ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุฅุฏุฎุงูู ูุฏููุงู.');
  };

  return (
    <Container className="mt-5">
      <Row className="justify-content-md-center">
        <Col md={8}>
          <h2 className="text-center mb-4">ุชุณููู ุงูุฒู ุงููุฏุฑุณู</h2>

          {error && <Alert variant="danger" onClose={() => setError('')} dismissible>{error}</Alert>}
          {success && <Alert variant="success" onClose={() => setSuccess('')} dismissible>{success}</Alert>}
          
          {showScanner ? (
            <div className="mb-3 text-center">
              <div style={{ maxWidth: '400px', margin: 'auto' }}>
                <BarcodeScanner 
                  onScanSuccess={handleScanSuccess}
                  onScanError={handleScanError}
                />
              </div>
              <Button variant="danger" className="mt-2 w-100" style={{ maxWidth: '400px' }} onClick={() => setShowScanner(false)}>
                ุฅุบูุงู ุงููุงููุฑุง
              </Button>
            </div>
          ) : (
            <Form onSubmit={handleBarcodeSearch}>
              <Form.Group as={Row} className="mb-3 align-items-center">
                <Form.Label column sm={3} className="text-end">ูุณุญ ุงูุจุงุฑููุฏ</Form.Label>
                <Col sm={9}>
                  <Form.Control
                    type="text"
                    ref={barcodeInputRef}
                    value={barcode}
                    onChange={(e) => setBarcode(e.target.value)}
                    placeholder="ุฃุฏุฎู ุฃู ุงูุณุญ ุงูุจุงุฑููุฏ ููุง"
                  />
                </Col>
              </Form.Group>
              <div className="d-grid gap-2 mb-4">
                <Button id="search-button" type="submit" disabled={loading || !barcode}>
                  {loading ? <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" /> : 'ุจุญุซ'}
                </Button>
                <Button variant="secondary" onClick={() => setShowScanner(true)}>
                  ๐ธ ูุณุญ ุจุงููุงููุฑุง
                </Button>
              </div>
            </Form>
          )}

          {item && (
            <Card>
              <Card.Header as="h5">ุชูุงุตูู ุงููุทุนุฉ</Card.Header>
              <Card.Body>
                <p><strong>ุงููุตู:</strong> {item.uniform?.stage} - {item.uniform?.type}</p>
                <p><strong>ุงูููุงุณ:</strong> {item.uniform?.size}</p>
                <p><strong>ุงูุจุงุฑููุฏ:</strong> {item.barcode}</p>
                <hr />
                <h4 className="mb-3">ุจูุงูุงุช ุงูุทุงูุจ ุงููุณุชูู</h4>
                <Form onSubmit={handleRecordDelivery}>
                  <Form.Group className="mb-3">
                    <Form.Label>ุงุณู ุงูุทุงูุจ</Form.Label>
                    <Form.Control type="text" name="studentName" value={studentData.studentName} onChange={handleChange} required />
                  </Form.Group>
                  <Row>
                    <Col>
                      <Form.Group className="mb-3">
                        <Form.Label>ุงููุฑุญูุฉ</Form.Label>
                        <Form.Select name="stage" value={studentData.stage} onChange={handleChange}>
                          {['ุฑูุงุถ ุฃุทูุงู ุจูุงุช', 'ุฑูุงุถ ุฃุทูุงู ุจููู', 'ุทูููุฉ ูุจูุฑุฉ ุจูุงุช', 'ุทูููุฉ ูุจูุฑุฉ ุจููู', 'ุงุจุชุฏุงุฆู', 'ูุชูุณุท', 'ุซุงููู'].map(s => <option key={s} value={s}>{s}</option>)}
                        </Form.Select>
                      </Form.Group>
                    </Col>
                    <Col>
                      <Form.Group className="mb-3">
                        <Form.Label>ุงูุตู</Form.Label>
                        <Form.Select name="grade" value={studentData.grade} onChange={handleChange}>
                           {['ุฃูู', 'ุซุงูู', 'ุซุงูุซ', 'ุฑุงุจุน', 'ุฎุงูุณ', 'ุณุงุฏุณ'].map(g => <option key={g} value={g}>{g}</option>)}
                        </Form.Select>
                      </Form.Group>
                    </Col>
                    <Col>
                      <Form.Group className="mb-3">
                        <Form.Label>ุงูุดุนุจุฉ</Form.Label>
                        <Form.Select name="section" value={studentData.section} onChange={handleChange}>
                          {['ุฃ', 'ุจ', 'ุฌ', 'ุฏ', 'ูู'].map(s => <option key={s} value={s}>{s}</option>)}
                        </Form.Select>
                      </Form.Group>
                    </Col>
                  </Row>
                  <div className="d-grid">
                    <Button variant="success" type="submit" disabled={loading}>
                      {loading ? <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" /> : 'ุชูุซูู ุงูุชุณููู'}
                    </Button>
                  </div>
                </Form>
              </Card.Body>
            </Card>
          )}
        </Col>
      </Row>
    </Container>
  );
}

 export default DeliverUniformPage;